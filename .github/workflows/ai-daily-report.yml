name: Daily AI Research Report

on:
  schedule:
    # 每天美国东部时间晚上11:15执行 (EST 23:15 = UTC 04:15)
    # 注意：GitHub Actions使用UTC时间，避开整点高峰
    - cron: '30 11 * * *'
  workflow_dispatch: # 允许手动触发
    inputs:
      force_run:
        description: '强制执行任务'
        required: false
        default: 'false'

jobs:
  send-daily-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: 发送每日AI研究报告
      run: |
        echo "开始执行每日AI研究报告任务..."
        
        # 调用Netlify部署的网站API
        # 使用SITE_URL构建完整的Function URL
        FUNCTION_URL="${{ secrets.SITE_URL }}/.netlify/functions/daily-task"
        echo "调用Function: $FUNCTION_URL"
        
        response=$(curl -s -w "%{http_code}" \
          -X POST \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -d '{}' \
          "$FUNCTION_URL" \
          -o response.json)
        
        http_code="${response: -3}"
        
        if [ "$http_code" -eq 200 ]; then
          echo "✅ 每日任务执行成功"
          cat response.json
        else
          echo "❌ 每日任务执行失败，HTTP状态码: $http_code"
          cat response.json
          exit 1
        fi
    
    - name: 通知执行结果
      if: always()
      run: |
        if [ $? -eq 0 ]; then
          echo "🎉 AI研究日报发送成功！"
        else
          echo "⚠️ AI研究日报发送失败，请检查日志"
        fi
